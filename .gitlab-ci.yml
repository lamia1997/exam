image: docker
variables:
  # DOCKER_HOST variable tells docker how to connect to the daemon (a background service running inside the Docker VM)
  DOCKER_HOST: "tcp://docker:2375/"
  # Environemt Variable for docker:dind service explaining to use overlay2 as supporting driver for docker
  # https://docs.docker.com/storage/storagedriver/overlayfs-driver/
  DOCKER_DRIVER: overlay2
  # We need to disable TLS (https://about.gitlab.com/blog/2019/07/31/docker-in-docker-with-docker-19-dot-03/#disable-tls)
  # to fix the error "docker: Cannot connect to the Docker daemon at tcp://docker:2375. Is the docker daemon running?"
  DOCKER_TLS_CERTDIR: ""


services:
  - docker:dind 

stages:
  - build-n-push-images
  - deploy_dev
  - deploy_prod

build-n-push-images:
  rules:
    - if: $ENVIRONMENT != "dev" || $ENVIRONMENT != "prod"
  before_script:
    - docker login -u $DOCKERHUB_USER -p $DOCKERHUB_PASSWORD
  tags:
    - docker
  stage: build-n-push-images
  script:
    - docker-compose -f docker-compose-build.yaml build --parallel
    - docker images
    - docker push $DOCKERHUB_USER/vote:v1
    - docker push $DOCKERHUB_USER/result:v1
    - docker push $DOCKERHUB_USER/worker:v1
    - docker push $DOCKERHUB_USER/seed:v1


